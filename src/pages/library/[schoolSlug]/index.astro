---
import { getCollection } from 'astro:content';
import BaseHead from '../../../components/BaseHead.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import LibrarySidebar from '../../../components/LibrarySidebar.astro';
import Sidebar from '../../../layouts/primitives/Sidebar.astro';
import Stack from '../../../layouts/primitives/Stack.astro';
import Grid from '../../../layouts/primitives/Grid.astro';
import Center from '../../../layouts/primitives/Center.astro';
import { SITE_TITLE } from '../../../consts';
import { schools, schoolsBySlug, type SchoolSlug } from '../../../data/schools';

export function getStaticPaths() {
	return schools.map((school) => ({
		params: { schoolSlug: school.slug },
	}));
}

const { schoolSlug } = Astro.params;
const school = schoolsBySlug[schoolSlug as SchoolSlug];

if (!school) {
	return Astro.redirect('/library');
}

// Get all atoms and group by school
const allAtoms = await getCollection('library');
const atomsBySchool = allAtoms.reduce(
	(acc, atom) => {
		const s = atom.data.school;
		if (!acc[s]) acc[s] = [];
		acc[s].push(atom);
		return acc;
	},
	{} as Record<string, typeof allAtoms>,
);

// Sort atoms
for (const s of Object.keys(atomsBySchool)) {
	atomsBySchool[s].sort((a, b) => a.data.title.localeCompare(b.data.title));
}

// Get atoms for this school
const schoolAtoms = atomsBySchool[schoolSlug] || [];

// Group atoms by domain (if they have one)
const atomsByDomain = schoolAtoms.reduce(
	(acc, atom) => {
		const domain = atom.data.domain || 'General';
		if (!acc[domain]) acc[domain] = [];
		acc[domain].push(atom);
		return acc;
	},
	{} as Record<string, typeof schoolAtoms>,
);

const domains = Object.keys(atomsByDomain).sort();

const difficultyColors: Record<string, string> = {
	beginner: 'difficulty-beginner',
	intermediate: 'difficulty-intermediate',
	advanced: 'difficulty-advanced',
};

// Format domain slug to title case
function formatDomain(domain: string): string {
	return domain
		.split('-')
		.map(word => word.charAt(0).toUpperCase() + word.slice(1))
		.join(' ');
}
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead
			title={`${school.name} | Library | ${SITE_TITLE}`}
			description={school.description}
		/>
	</head>
	<body>
		<Header />
		<main>
			<Center max="75rem" gutters="0">
				<Sidebar sideWidth="16rem" contentMin="60%" space="0" noStretch>
					<aside class="sidebar-container">
						<LibrarySidebar atomsBySchool={atomsBySchool} currentSchool={schoolSlug} />
					</aside>
					<div class="main-content region">
						<Center max="var(--measure-wide)" gutters="var(--space-m)">
							<Stack space="var(--space-xl)">
								<!-- Breadcrumb -->
								<nav class="breadcrumb text-small">
									<a href="/library">Library</a>
									<span class="separator">/</span>
									<span>{school.name}</span>
								</nav>

								<!-- School Header -->
								<header class="school-header">
									<Stack space="var(--space-m)">
										<div class="school-title-row">
											<span class="school-emoji">{school.emoji}</span>
											<h1>{school.name}</h1>
										</div>
										<p class="school-philosophy">{school.corePhilosophy}</p>
									</Stack>
								</header>

								<!-- Historical Context -->
								<section>
									<Stack space="var(--space-s)">
										<h2>Historical Context</h2>
										<p>{school.historicalContext}</p>
									</Stack>
								</section>

								<!-- Why It Matters Today -->
								<section>
									<Stack space="var(--space-s)">
										<h2>Why It Matters Today</h2>
										<p>{school.whyItMatters}</p>
									</Stack>
								</section>

								<!-- Who This Is For -->
								<section>
									<Stack space="var(--space-s)">
										<h2>Who This Is For</h2>
										<p>{school.whoThisIsFor}</p>
									</Stack>
								</section>

								<!-- Domains Section -->
								<section>
									<Stack space="var(--space-m)">
										<h2>Domains</h2>

										{school.domains.length > 0 ? (
											<Stack space="var(--space-s)">
												<p class="text-muted">
													This school covers the following domains. Content is being added progressively.
												</p>
												<ul class="domain-list">
													{school.domains.map((domain) => (
														<li>
															<a href={`/library/${schoolSlug}/${domain}/`} class="domain-tag">
																{formatDomain(domain)}
															</a>
														</li>
													))}
												</ul>
											</Stack>
										) : (
											<p class="text-muted">Domains coming soon.</p>
										)}
									</Stack>
								</section>

								<!-- Atoms Section -->
								<section>
									<Stack space="var(--space-m)">
										<h2>Atoms</h2>

										{schoolAtoms.length > 0 ? (
											<Stack space="var(--space-l)">
												{domains.map((domain) => (
													<Stack space="var(--space-s)">
														{domain !== 'General' && (
															<h3 class="h4 domain-heading">{formatDomain(domain)}</h3>
														)}
														<Grid min="280px" space="var(--space-m)">
															{atomsByDomain[domain].map((atom) => (
																<a href={`/library/${schoolSlug}/${atom.data.domain}/${atom.id}/`} class="atom-card card">
																	<Stack space="var(--space-2xs)">
																		<h4 class="atom-title">{atom.data.title}</h4>
																		<p class="atom-description">{atom.data.description}</p>
																		{atom.data.difficulty && (
																			<span class={`difficulty-badge ${difficultyColors[atom.data.difficulty]}`}>
																				{atom.data.difficulty}
																			</span>
																		)}
																	</Stack>
																</a>
															))}
														</Grid>
													</Stack>
												))}
											</Stack>
										) : (
											<div class="empty-state">
												<Stack space="var(--space-xs)">
													<p class="text-muted">No atoms in this school yet.</p>
													<p class="text-small text-muted">
														We're actively building the Library. Check back soon or
														<a href="/#subscribe">subscribe</a> to get notified when new content is added.
													</p>
												</Stack>
											</div>
										)}
									</Stack>
								</section>
							</Stack>
						</Center>
					</div>
				</Sidebar>
			</Center>
		</main>
		<Footer />
	</body>
</html>

<style>
	.sidebar-container {
		border-inline-end: 1px solid var(--color-border);
		block-size: 100%;
	}

	@media (max-width: 50rem) {
		.sidebar-container {
			display: none;
		}
	}

	.breadcrumb {
		color: var(--color-text-muted);
	}

	.breadcrumb a {
		color: inherit;
		text-decoration: none;
	}

	.breadcrumb a:hover {
		color: var(--color-text);
	}

	.separator {
		margin-inline: var(--space-2xs);
	}

	/* School Header */
	.school-header {
		padding-block-end: var(--space-l);
		border-block-end: 1px solid var(--color-border);
	}

	.school-title-row {
		display: flex;
		align-items: center;
		gap: var(--space-s);
	}

	.school-emoji {
		font-size: var(--step-4);
		line-height: 1;
	}

	.school-philosophy {
		font-size: var(--step-1);
		color: var(--color-text-muted);
		font-style: italic;
		max-inline-size: 65ch;
	}

	/* Prose sections */
	section p {
		line-height: 1.7;
		max-inline-size: 65ch;
	}

	section h2 {
		font-size: var(--step-2);
	}

	/* Domains */
	.domain-list {
		display: flex;
		flex-wrap: wrap;
		gap: var(--space-2xs);
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.domain-list li {
		margin: 0;
		padding: 0;
	}

	.domain-tag {
		display: inline-block;
		padding-block: var(--space-3xs);
		padding-inline: var(--space-s);
		margin: 0;
		font-size: var(--step--1);
		background-color: var(--color-bg-subtle);
		border: 1px solid var(--color-border);
		border-radius: 9999px;
		text-decoration: none;
		color: inherit;
		transition: border-color 0.15s ease, background-color 0.15s ease;
	}

	.domain-tag:hover {
		border-color: var(--color-text-muted);
		background-color: var(--color-bg);
	}

	.domain-heading {
		padding-block-end: var(--space-2xs);
		border-block-end: 1px solid var(--color-border);
		color: var(--color-text-muted);
	}

	/* Atom Cards */
	.atom-card {
		display: block;
		text-decoration: none;
		color: inherit;
	}

	.atom-title {
		font-size: var(--step-0);
		font-weight: 600;
		line-height: 1.3;
		transition: color 0.15s ease;
	}

	.atom-card:hover .atom-title {
		color: var(--color-accent);
	}

	.atom-description {
		font-size: var(--step--1);
		color: var(--color-text-muted);
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.difficulty-badge {
		display: inline-block;
		width: fit-content;
		padding-inline: var(--space-2xs);
		padding-block: var(--space-3xs);
		font-size: var(--step--2);
		font-weight: 500;
		border-radius: 9999px;
	}

	.difficulty-beginner {
		background-color: color-mix(in srgb, #22c55e 15%, transparent);
		color: #15803d;
	}

	.difficulty-intermediate {
		background-color: color-mix(in srgb, #eab308 15%, transparent);
		color: #a16207;
	}

	.difficulty-advanced {
		background-color: color-mix(in srgb, #ef4444 15%, transparent);
		color: #b91c1c;
	}

	/* Empty State */
	.empty-state {
		padding: var(--space-l);
		background-color: var(--color-bg-subtle);
		border-radius: var(--space-xs);
		text-align: center;
	}

	.empty-state a {
		color: var(--color-accent);
	}
</style>
